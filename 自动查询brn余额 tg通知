import asyncio
import time
from web3 import Web3
from telegram import Bot
from telegram.ext import Application

# é…ç½® æ”¹è¿™
TELEGRAM_TOKEN = ""
CHAT_ID = ""

# éœ€è¦æŸ¥è¯¢çš„è´¦æˆ·åˆ—è¡¨
ACCOUNTS = [
    "",
    "",
    "",
    "",
    "",
]

# Caldera é…ç½®
CALDERA_RPC_URL = "https://b2n.rpc.caldera.xyz/http"
CHAIN_ID = 334
EXPLORER_URL = "https://b2n.explorer.caldera.xyz"
SYMBOL = "BRN"
# Arbitrum æµ‹è¯•ç½‘é…ç½®
ARB_RPC_URL = "https://arbitrum-sepolia-rpc.publicnode.com"  # Arbitrum Sepolia Testnet
# Unichain æµ‹è¯•ç½‘é…ç½®
UNI_RPC_URL = "https://unichain-sepolia-rpc.publicnode.com"  # Unichain Sepolia Testnet

# è¿æ¥åˆ°å„ä¸ªåŒºå—é“¾
print("å°è¯•è¿æ¥åˆ° Caldera åŒºå—é“¾...")
caldera_w3 = Web3(Web3.HTTPProvider(CALDERA_RPC_URL))
if not caldera_w3.is_connected():
    raise Exception("æ— æ³•è¿æ¥åˆ° Caldera åŒºå—é“¾ RPC")
print("Caldera åŒºå—é“¾è¿æ¥æˆåŠŸ")

print("å°è¯•è¿æ¥åˆ° Arbitrum æµ‹è¯•ç½‘...")
arb_w3 = Web3(Web3.HTTPProvider(ARB_RPC_URL))
if not arb_w3.is_connected():
    raise Exception("æ— æ³•è¿æ¥åˆ° Arbitrum æµ‹è¯•ç½‘ RPC")
print("Arbitrum æµ‹è¯•ç½‘è¿æ¥æˆåŠŸ")

print("å°è¯•è¿æ¥åˆ° Unichain æµ‹è¯•ç½‘...")
uni_w3 = Web3(Web3.HTTPProvider(UNI_RPC_URL))
if not uni_w3.is_connected():
    raise Exception("æ— æ³•è¿æ¥åˆ° Unichain æµ‹è¯•ç½‘ RPC")
print("Unichain æµ‹è¯•ç½‘è¿æ¥æˆåŠŸ")

# æŸ¥è¯¢å„ä¸ªç½‘ç»œçš„æ€»ä½™é¢
def get_caldera_balance():
    total_balance = 0
    for account in ACCOUNTS:
        try:
            balance_wei = caldera_w3.eth.get_balance(account)
            balance = caldera_w3.from_wei(balance_wei, 'ether')
            total_balance += balance
        except Exception as e:
            print(f"æŸ¥è¯¢ Caldera è´¦æˆ· {account} å¤±è´¥: {str(e)}")
    print(f"å½“å‰ Caldera æ€»ä½™é¢: {total_balance}")
    return total_balance

def get_arb_balance():
    total_balance = 0
    for account in ACCOUNTS:
        try:
            balance_wei = arb_w3.eth.get_balance(account)
            balance = arb_w3.from_wei(balance_wei, 'ether')
            total_balance += balance
        except Exception as e:
            print(f"æŸ¥è¯¢ Arbitrum è´¦æˆ· {account} å¤±è´¥: {str(e)}")
    print(f"å½“å‰ Arbitrum æ€»ä½™é¢: {total_balance}")
    return total_balance

def get_uni_balance():
    total_balance = 0
    for account in ACCOUNTS:
        try:
            balance_wei = uni_w3.eth.get_balance(account)
            balance = uni_w3.from_wei(balance_wei, 'ether')
            total_balance += balance
        except Exception as e:
            print(f"æŸ¥è¯¢ Unichain è´¦æˆ· {account} å¤±è´¥: {str(e)}")
    print(f"å½“å‰ Unichain æ€»ä½™é¢: {total_balance}")
    return total_balance

# æ ¼å¼åŒ–æ—¶é—´
def format_time(seconds):
    hours = int(seconds // 3600)
    minutes = int((seconds % 3600) // 60)
    secs = int(seconds % 60)
    return f"{hours}å°æ—¶ {minutes}åˆ†é’Ÿ {secs}ç§’"

# å‘é€ Telegram æ¶ˆæ¯çš„å¼‚æ­¥å‡½æ•°
async def send_balance_update(bot, previous_caldera_balance, interval_count, start_time, initial_caldera_balance):
    print(f"ç¬¬ {interval_count} æ¬¡æ›´æ–°å¼€å§‹")
    caldera_balance = get_caldera_balance()
    arb_balance = get_arb_balance()
    uni_balance = get_uni_balance()
    total_eth_balance = arb_balance + uni_balance  # è®¡ç®— ETH æ€»ä½™é¢
    elapsed_time = time.time() - start_time
    difference = float(caldera_balance - (previous_caldera_balance or 0)) if previous_caldera_balance is not None else 0
    total_increase = float(caldera_balance - initial_caldera_balance) if initial_caldera_balance is not None else 0
    
    # è®¡ç®— 24 å°æ—¶é¢„ä¼°æ”¶ç›Šï¼ˆ24å°æ—¶ = 1440åˆ†é’Ÿï¼‰
    avg_per_minute = total_increase / (elapsed_time / 60) if elapsed_time > 0 else 0
    estimated_24h = avg_per_minute * 1440
    
    message = f"ğŸ“Š {SYMBOL} æ€»ä½™é¢æ›´æ–° ({time.strftime('%Y-%m-%d %H:%M:%S')}):\n"
    message += f"å½“å‰ {SYMBOL} æ€»ä½™é¢: {caldera_balance:.4f} {SYMBOL}\n"
    message += f"å‰1åˆ†é’Ÿå¢åŠ : {difference:+.4f} {SYMBOL}\n"
    message += f"å†å²æ€»å…±å¢åŠ : {total_increase:+.4f} {SYMBOL}\n"
    message += f"æ€»å…±è¿è¡Œæ—¶é—´: {format_time(elapsed_time)}\n"
    message += f"24å°æ—¶é¢„ä¼°æ”¶ç›Š: {estimated_24h:+.4f} {SYMBOL}\n"
    message += f"Arb ETH ä½™é¢: {arb_balance:.4f} ETH\n"
    message += f"Uni ETH ä½™é¢: {uni_balance:.4f} ETH\n"
    message += f"ETH æ€»ä½™é¢: {total_eth_balance:.4f} ETH"
    
    print(f"å°è¯•å‘é€æ¶ˆæ¯: {message}")
    try:
        await bot.send_message(chat_id=CHAT_ID, text=message, parse_mode='Markdown')
        print("æ¶ˆæ¯å‘é€æˆåŠŸ")
    except Exception as e:
        print(f"æ¶ˆæ¯å‘é€å¤±è´¥: {str(e)}")
    
    return caldera_balance

# ä¸»å¾ªç¯
async def main():
    print("å¯åŠ¨ Telegram Bot...")
    bot = Bot(TELEGRAM_TOKEN)
    app = Application.builder().token(TELEGRAM_TOKEN).build()
    print("Bot åˆå§‹åŒ–å®Œæˆ")

    previous_caldera_balance = None
    interval_count = 0
    start_time = time.time()
    initial_caldera_balance = get_caldera_balance()  # è®°å½•åˆå§‹ä½™é¢
    
    while True:
        interval_count += 1
        previous_caldera_balance = await send_balance_update(bot, previous_caldera_balance, interval_count, start_time, initial_caldera_balance)
        print(f"ç­‰å¾…ä¸‹ä¸€æ¬¡æ›´æ–°...")
        await asyncio.sleep(60)  # æ¯1åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡

if __name__ == "__main__":
    asyncio.run(main())
